import{c as ee,j as e,r as _,g as te,ai as G,h as z,z as fe,E as je,I as N,H as J,J as ye,F as ie,i as re,k as v,T as u,l as E,q as R,D as _e,B as h,p as I,a8 as se,Y as be,u as ve,a as we,f as Ce,aj as Se,G as Ie,_ as ke,$ as Q,K as L,b as $,ah as X,o as Te,R as Ae,U as De,x as Pe,e as $e}from"./index-CcV8hKYk.js";import{u as ze}from"./CategoryContext-D4o34mBX.js";const Fe=ee(e.jsx("path",{d:"M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2m0 14H8V4h12zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4zm12 6V9c0-.55-.45-1-1-1h-2v5h2c.55 0 1-.45 1-1m-2-3h1v3h-1zm4 2h1v-1h-1V9h1V8h-2v5h1zm-8 0h1c.55 0 1-.45 1-1V9c0-.55-.45-1-1-1H9v5h1zm0-2h1v1h-1z"})),We=ee(e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8m-2.5-3.5 7-4.5-7-4.5z"})),Re=se("input")({clip:"rect(0 0 0 0)",clipPath:"inset(50%)",height:1,overflow:"hidden",position:"absolute",bottom:0,left:0,whiteSpace:"nowrap",width:1}),M=({label:g,name:s,accept:D,icon:x,values:j,touched:F,errors:P,setFieldValue:k,setRemoveFile:S})=>e.jsxs(v,{fullWidth:!0,children:[e.jsx(u,{sx:{mx:.5,mb:.4},children:g}),e.jsxs(I,{component:"label",variant:"outlined",children:["Upload ",g,e.jsx(Re,{type:"file",accept:D,multiple:!0,onChange:o=>{const d=Array.from(o.currentTarget.files||[]).map(n=>Object.assign(n,{preview:URL.createObjectURL(n)}));k(s,[...j[s]||[],...d])}})]}),j[s]?.length>0&&e.jsx(h,{mt:2,display:"flex",flexWrap:"wrap",gap:2,children:j[s].map((o,f)=>e.jsxs(h,{display:"flex",alignItems:"center",gap:1,sx:{position:"relative",border:"1px solid #ccc",borderRadius:"8px",padding:"8px 12px",backgroundColor:"#f9f9f9",width:s==="image"?"146px":"auto",cursor:"pointer"},onClick:()=>{const d=o.preview||`https://bossmakeradmin.bossmakercpa.com/${o?.file_path}`;if(s==="video"){const n=window.open("");n&&n.document.write(`
                                        <video controls autoplay style="width:100%; height:100vh;">
                                        <source src="${d}" type="video/mp4">
                                        Your browser does not support the video tag.
                                        </video>
                                    `)}else s==="document"&&window.open(d,"_blank")},children:[e.jsx(N,{sx:{position:"absolute",top:"-11px",right:"-11px",padding:"4px",color:"#fff",bgcolor:"black","&:hover":{bgcolor:"black"}},onClick:d=>{d.stopPropagation();const n=j[s].filter((m,w)=>w!==f);k(s,n),o._id&&S(m=>[...m,o._id])},children:e.jsx(J,{fontSize:"small"})}),s==="image"?e.jsx("img",{src:o.preview||`https://bossmakeradmin.bossmakercpa.com/${o?.file_path}`,alt:"preview",style:{width:"100%",maxHeight:"180px",objectFit:"contain"}}):e.jsxs(e.Fragment,{children:[x,e.jsx(u,{variant:"body2",noWrap:!0,maxWidth:500,children:o.name||o?.file_name})]})]},f))})]});function Ee({open:g,handleClose:s,setSectionFormData:D,selectedSection:x,setRemoveFile:j}){const[F,P]=_.useState(!1),[k,S]=_.useState({_id:"",title:"",lesson:"",image:[],video:[],document:[]});_.useEffect(()=>{S(x?{_id:x._id||"",title:x.title||"",lesson:x.lesson||"",image:x.image||[],video:x.video||[],document:x.document||[]}:{_id:"",title:"",lesson:"",image:[],video:[],document:[]})},[x]);const o=te({title:z().required("Section Title is required"),image:G().test("oneOfRequired","At least one media file (image, video, or document) is required",function(){const{image:d,video:n,document:m}=this.parent;return Array.isArray(d)&&d.length>0||Array.isArray(n)&&n.length>0||Array.isArray(m)&&m.length>0})}),f=async d=>{P(!0),D(n=>{const m=Array.isArray(n)?n:[];return x?m.map(w=>w._id===x._id?{...w,...d}:w):[...m,{...d,_id:Date.now().toString()}]}),P(!1),s(),S({_id:"",title:"",lesson:"",image:[],video:[],document:[]})};return e.jsxs(fe,{fullWidth:!0,open:g,onClose:s,children:[e.jsxs(je,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[x?"Update":"Add"," Section",e.jsx(N,{onClick:s,sx:{border:"1px solid black"},children:e.jsx(J,{})})]}),e.jsx(ye,{dividers:!0,children:e.jsx(ie,{initialValues:k,enableReinitialize:!0,validationSchema:o,onSubmit:f,children:({errors:d,handleChange:n,values:m,handleBlur:w,touched:y,setFieldValue:T})=>e.jsxs(re,{style:{display:"flex",flexDirection:"column",gap:"1rem",marginTop:"0.5rem"},children:[e.jsxs(v,{fullWidth:!0,children:[e.jsx(u,{sx:{mx:.5,mb:.4},children:"Section Title"}),e.jsx(E,{name:"title",placeholder:"Section Title",value:m.title,onChange:n,onBlur:w,error:y.title&&!!d.title,helperText:y.title&&d.title})]}),e.jsxs(v,{fullWidth:!0,children:[e.jsx(u,{sx:{mx:.5,mb:.4},children:"Text Lesson"}),e.jsx(E,{name:"lesson",multiline:!0,rows:4,placeholder:"Text Lesson",value:m.lesson,onChange:n})]}),e.jsx(M,{label:"Image",name:"image",accept:"image/*",icon:null,values:m,setFieldValue:T,setRemoveFile:j}),e.jsx(M,{label:"Video",name:"video",accept:"video/*",icon:e.jsx(We,{fontSize:"large"}),values:m,setFieldValue:T,setRemoveFile:j}),e.jsx(M,{label:"Document",name:"document",accept:"application/pdf, application/msword, application/vnd.openxmlformats-officedocument.wordprocessingml.document",icon:e.jsx(Fe,{fontSize:"large"}),values:m,setFieldValue:T,setRemoveFile:j}),d.image&&e.jsx(R,{sx:{mt:.5,mx:0},error:!0,children:d.image}),e.jsx(_e,{sx:{mx:-3}}),e.jsxs(h,{sx:{display:"flex",justifyContent:"end",gap:"10px"},children:[e.jsx(I,{loading:F,type:"submit",variant:"contained",sx:{bgcolor:"black",width:"100px",borderRadius:"10px",fontWeight:"500",fontSize:"18px"},children:x?"Update":"Add"}),e.jsx(I,{variant:"contained",sx:{bgcolor:"white",color:"black",width:"100px",borderRadius:"10px",fontWeight:"500",fontSize:"18px"},onClick:s,children:"Cancel"})]})]})})})]})}const Be=48,qe=8,Z={PaperProps:{style:{maxHeight:Be*4.5+qe,width:250}}},Oe=se("input")({clip:"rect(0 0 0 0)",clipPath:"inset(50%)",height:1,overflow:"hidden",position:"absolute",bottom:0,left:0,whiteSpace:"nowrap",width:1});function Ve(){const{id:g}=be(),{user:s}=ve(),D=we(),{categoryData:x,refetchCategories:j,instructors:F,refetchInstructors:P,participants:k,refetchParticipants:S}=ze(),{showToast:o}=Ce(),f=$e(),[d,n]=_.useState(!1),[m,w]=_.useState({title:"",description:"",category:"",status:"active",instructor_ids:"",participant_ids:[],course_image:[],sections:[]}),[y,T]=_.useState([]),[ae,oe]=_.useState([]),[ne,B]=_.useState(!1),[q,O]=_.useState([]),[ce,U]=_.useState(null),Y=async i=>{try{const{data:p,status:c,error:a}=await f(`/api/categories/finduserbycategory/${i}`,"GET");c===200?oe(p.data):o(a,"error")}catch{o("Failed to fetch course.","error")}},le=async()=>{try{const{data:i,status:p,error:c}=await f(`/api/course/${g}`,"GET");if(p===200){const a=i.course;a.category=a.category_id?._id,a.instructor_ids=a.instructor_ids||"",a.participant_ids=a.participant_ids?.map(b=>b._id)||[],a.course_image=a.course_image,a.status=a.status===!0?"active":"inactive",T(a.sections||[]),w(a),s?.user_type===1&&a.instructor_ids&&Y(a.instructor_ids)}else o(c,"error")}catch{o("Failed to fetch course.","error")}};_.useEffect(()=>{g?(s?.user_type===1?P():S(),le(),s?.user_type===2&&j()):(s?.user_type===1?P():S(),s?.user_type===2&&j())},[]);const H=s?.user_type===1?ae:x,de=i=>{U(i),B(!0)},pe=()=>{B(!1),U(null)},ue=te({title:z().required("Course Title required"),description:z().required("Description required"),instructor_ids:s?.user_type===1?z().required("Instructor required"):z(),participant_ids:s?.user_type===2?G().min(1,"At least one participant required"):G(),category:z().required("Category required"),course_image:Se().required("Course Image required")}),xe=async i=>{n(!0);const p={title:i.title,description:i.description,category_id:i.category,status:i.status==="active",sections:y||[],...s?.user_type===1?{instructor_ids:i.instructor_ids}:{participant_ids:JSON.stringify(i.participant_ids)}};try{if(i.course_image instanceof File){const r=new FormData;r.append("file",i.course_image);const{data:l,status:C,error:A}=await f("/api/uploadFile","POST",r,!0);if(C===200)p.course_image=l.data;else{o(A||"Image upload failed","error"),n(!1);return}}else p.course_image=i.course_image;if(Array.isArray(y)&&y.length>0){const r=[];for(const l of y){const C={_id:l._id||null,title:l.title,lesson:l.lesson,image:[],video:[],document:[]};for(const A of["image","video","document"])if(Array.isArray(l[A]))for(const V of l[A])if(V instanceof File){const K=new FormData;K.append("file",V);const{data:me,status:he,error:ge}=await f("/api/uploadFile","POST",K,!0);if(he===200)C[A].push(me.data);else{o(ge||`${A} upload failed`,"error"),n(!1);return}}else C[A].push(V);r.push(C)}p.sections=r}if(Array.isArray(q)&&q.length>0){const{status:r,error:l}=await f("/api/uploadFile/delete","DELETE",{ids:q});r!==200&&o(l||"Failed to delete files.","error")}const c=g?`/api/course/update/${g}`:"/api/course/create",a=g?"PUT":"POST",{data:b,status:W,error:t}=await f(c,a,p);W===200?(o(b.message,"success"),O([]),D("/admin/course")):o(t||"Course submission failed","error")}catch{o("Failed to update course.","error")}finally{n(!1)}};return e.jsxs(h,{style:{padding:"1.25rem",height:"100%",overflowY:"auto"},children:[e.jsxs("div",{children:[e.jsxs(u,{variant:"subtitle1",fontSize:"1.5rem",fontWeight:500,children:[g?"Update":"Create"," Course"]}),e.jsx(u,{variant:"subtitle2",fontWeight:500,children:"Details about the course"})]}),e.jsx(Ie,{container:!0,spacing:2,justifyContent:"center",my:2,children:e.jsx(ie,{initialValues:m,enableReinitialize:!0,validationSchema:ue,onSubmit:xe,children:({errors:i,handleChange:p,values:c,handleBlur:a,touched:b,setFieldValue:W})=>e.jsxs(re,{style:{width:"100%",display:"flex",flexDirection:"column",gap:"1rem",marginTop:"0.5rem"},children:[e.jsxs(h,{sx:{display:"flex",gap:"2rem",width:"100%"},children:[e.jsxs(v,{fullWidth:!0,error:!!i.title,children:[e.jsx(u,{sx:{mx:.5,mb:.4},children:"Course Title"}),e.jsx(E,{id:"title",name:"title",type:"text",placeholder:"Course Title",value:c.title,onChange:p,onBlur:a,error:b.title&&!!i.title,helperText:b.title&&i.title})]}),e.jsxs(v,{fullWidth:!0,children:[e.jsx(u,{sx:{mx:.5,mb:.4},children:"Status"}),e.jsxs(ke,{sx:{padding:"10px 0px",gap:"1rem"},children:[e.jsx(Q,{checked:c.status==="active",onChange:p,value:"active",label:"Active",name:"status",size:"md"}),e.jsx(Q,{checked:c.status==="inactive",onChange:p,value:"inactive",label:"Inactive",name:"status",size:"md"})]})]})]}),e.jsxs(h,{sx:{display:"flex",gap:"2rem",width:"100%"},children:[s?.user_type===1?e.jsxs(v,{fullWidth:!0,error:!!i.instructor_ids,children:[e.jsx(u,{sx:{mx:.5,mb:.4},children:"Instructors"}),e.jsxs(L,{displayEmpty:!0,id:"instructor_ids",name:"instructor_ids",MenuProps:Z,value:c.instructor_ids||[],onChange:t=>{p(t);const r=t.target.value;r&&(Y(r),W("category",""))},onBlur:a,renderValue:t=>{if(!t||t.length===0)return e.jsx("span",{style:{color:"#aaa"},children:"Select Instructors"});const r=F.find(l=>l._id===t);return r?`${r.first_name} ${r.last_name}`:""},children:[e.jsx($,{disabled:!0,value:"",children:e.jsx("em",{children:"Select Instructors"})}),F.map(t=>e.jsx($,{value:t._id,children:e.jsx(X,{primary:`${t.first_name} ${t.last_name}`})},t._id))]}),i.instructor_ids&&e.jsx(R,{children:i.instructor_ids})]}):e.jsxs(v,{fullWidth:!0,error:!!i.participant_ids,children:[e.jsx(u,{sx:{mx:.5,mb:.4},children:"Participants"}),e.jsxs(L,{multiple:!0,displayEmpty:!0,label:"",id:"participant_ids",name:"participant_ids",MenuProps:Z,value:c.participant_ids||[],onChange:p,onBlur:a,renderValue:t=>!t||t.length===0?e.jsx("span",{style:{color:"#aaa"},children:"Select Participants"}):t.map(r=>{const l=k.find(C=>C._id===r);return l?`${l.first_name} ${l.last_name}`:""}).join(", "),children:[e.jsx($,{value:"",disabled:!0,children:e.jsx("em",{children:"Select Participants"})}),k.map(t=>e.jsxs($,{value:t._id,children:[e.jsx(Te,{color:"black",checked:c.participant_ids?.includes(t._id)}),e.jsx(X,{primary:`${t.first_name} ${t.last_name}`})]},t._id))]}),i.participant_ids&&e.jsx(R,{children:i.participant_ids})]}),e.jsxs(v,{fullWidth:!0,error:!!i.category,children:[e.jsx(u,{sx:{mx:.5,mb:.4},children:"Category"}),e.jsxs(L,{id:"category",name:"category",value:c.category,onChange:p,onBlur:a,displayEmpty:!0,renderValue:t=>{const r=H.find(l=>l._id===t);return r?r.name:e.jsx("span",{style:{color:"#aaa"},children:"Select Category"})},children:[e.jsx($,{disabled:!0,value:"",children:e.jsx("em",{children:"Select Category"})}),H.length>0&&H.map(t=>e.jsx($,{value:t._id,children:t.name},t._id))]}),b.category&&!!i.category&&e.jsx(R,{children:i.category})]})]}),e.jsxs(h,{sx:{display:"flex",gap:"2rem",width:"100%"},children:[e.jsxs(v,{fullWidth:!0,error:!!i.description,children:[e.jsx(u,{sx:{mx:.5,mb:.4},children:"Description"}),e.jsx(E,{id:"description",type:"text",multiline:!0,rows:4,placeholder:"Description",value:c.description,onChange:p,onBlur:a,error:b.description&&!!i.description,helperText:b.description&&i.description})]}),e.jsxs(v,{fullWidth:!0,children:[e.jsx(u,{sx:{mx:.5,mb:.4},children:"Course Image"}),e.jsxs(h,{component:"label",role:void 0,tabIndex:-1,sx:{border:"1px dashed #ccc",borderRadius:"8px",p:"6px"},children:[c.course_image?.preview||c.course_image?.file_path?e.jsxs(h,{sx:{display:"flex",justifyContent:"center",position:"relative"},children:[e.jsx("img",{src:c.course_image.preview||`https://bossmakeradmin.bossmakercpa.com/${c.course_image?.file_path}`,alt:"Course Preview",style:{width:120,height:120,objectFit:"cover",borderRadius:8}}),e.jsx(N,{sx:{position:"absolute",top:0,right:0,padding:"4px",color:"#fff",bgcolor:"rgba(0,0,0,0.6)","&:hover":{bgcolor:"black"}},onClick:async t=>{t.stopPropagation(),c.course_image?._id&&O(r=>[...r,c.course_image?._id]),W("course_image",null)},children:e.jsx(J,{fontSize:"small"})})]}):e.jsxs(h,{sx:{py:4,cursor:"pointer"},children:[e.jsx(u,{textAlign:"center",fontWeight:700,children:"Drop file here or click to upload"}),e.jsx(u,{textAlign:"center",children:"JPG, PNG, PDF, or Video files. Max file size 3MB."})]}),e.jsx(Oe,{type:"file",id:"course_image",name:"course_image",accept:"image/*",onBlur:a,onChange:t=>{const r=t.currentTarget.files[0];if(r){const l=Object.assign(r,{preview:URL.createObjectURL(r)});W("course_image",l)}}})]}),b.course_image&&!!i.course_image&&e.jsx(R,{error:!0,children:i.course_image})]})]}),e.jsxs(h,{children:[y?.length>0&&e.jsx(u,{sx:{mx:.5,mb:.4},children:"Sections"}),y?.length>0&&y.map((t,r)=>e.jsxs(h,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",my:1,p:2,backgroundColor:"#f9f9f9",border:"1px solid #ccc",borderRadius:"8px"},children:[e.jsx(h,{children:e.jsx(u,{variant:"h6",children:t.title})}),e.jsxs(h,{sx:{display:"flex",gap:"10px"},children:[e.jsx(I,{variant:"outlined",color:"primary",onClick:()=>de(t),startIcon:e.jsx(Ae,{}),children:"Edit"}),e.jsx(I,{variant:"outlined",color:"error",startIcon:e.jsx(De,{}),onClick:()=>{const l=y.filter(C=>C!==t);T(l)},children:"Delete"})]})]},r))]}),e.jsx(h,{children:e.jsx(I,{variant:"contained",color:"primary",sx:{bgcolor:"black",borderRadius:"10px",padding:"5px 10px",fontWeight:"500",fontSize:"18px"},startIcon:e.jsx(Pe,{}),onClick:()=>{U(null),B(!0)},children:"Add Section"})}),e.jsxs(h,{sx:{display:"flex",justifyContent:"end",gap:"10px",width:"100%",my:2},children:[e.jsx(I,{loading:d,type:"submit",variant:"contained",color:"primary",sx:{backgroundColor:"black",width:"100px",borderRadius:"10px",padding:"10px",fontWeight:"500",fontSize:"18px"},children:g?"Update":"Save"}),e.jsx(I,{variant:"contained",color:"",sx:{backgroundColor:"white",width:"100px",borderRadius:"10px",padding:"10px",fontWeight:"500",fontSize:"18px"},onClick:()=>D("/admin/course"),children:"Cancel"})]})]})})}),e.jsx(Ee,{open:ne,handleClose:pe,setSectionFormData:T,selectedSection:ce,setRemoveFile:O})]})}export{Ve as default};
